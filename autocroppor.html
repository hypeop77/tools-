<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BatchDocCropper - AI-Powered Document Cropping</title>
    <style>
        :root {
            --primary-color: #3a86ff;
            --primary-dark: #2667cc;
            --secondary-color: #8338ec;
            --success-color: #06d6a0;
            --warning-color: #ffd166;
            --error-color: #ef476f;
            --bg-color: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-color: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2d2d2d;
            --text-color: #e9ecef;
            --text-secondary: #adb5bd;
            --border-color: #404040;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: var(--transition);
        }

        .app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background-color: var(--primary-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-icon {
            padding: 0.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .btn-icon:hover {
            background-color: var(--bg-tertiary);
        }

        /* Main Content Styles */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 300px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .file-counter {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .file-item {
            display: flex;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .file-item:hover {
            background-color: var(--bg-tertiary);
        }

        .file-item.active {
            border-color: var(--primary-color);
            background-color: rgba(58, 134, 255, 0.1);
        }

        .file-thumbnail {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            background-color: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .file-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .file-info {
            flex: 1;
            overflow: hidden;
        }

        .file-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }

        .file-details {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        .file-status {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
        }

        .status-badge {
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.625rem;
            font-weight: 500;
        }

        .status-waiting {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .status-processing {
            background-color: var(--warning-color);
            color: #000;
        }

        .status-done {
            background-color: var(--success-color);
            color: white;
        }

        .status-error {
            background-color: var(--error-color);
            color: white;
        }

        /* Editor Styles */
        .editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-title {
            font-weight: 600;
        }

        .editor-actions {
            display: flex;
            gap: 0.5rem;
        }

        .editor-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            padding: 1rem;
            background-color: var(--bg-tertiary);
            position: relative;
        }

        #editor-canvas {
            max-width: 100%;
            max-height: 100%;
            box-shadow: var(--shadow);
            background-color: white;
            cursor: crosshair;
        }

        .crop-list {
            width: 250px;
            border-left: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .crop-list-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .crop-items {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .crop-item {
            display: flex;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .crop-item:hover {
            background-color: var(--bg-tertiary);
        }

        .crop-item.active {
            border-color: var(--primary-color);
            background-color: rgba(58, 134, 255, 0.1);
        }

        .crop-thumbnail {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            background-color: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .crop-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .crop-info {
            flex: 1;
            overflow: hidden;
        }

        .crop-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .crop-details {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .crop-actions {
            display: flex;
            gap: 0.25rem;
        }

        /* Upload Area Styles */
        .upload-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            background-color: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            font-size: 2rem;
        }

        .upload-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .upload-description {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            max-width: 500px;
        }

        .upload-zone {
            width: 100%;
            max-width: 500px;
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 2rem;
            transition: var(--transition);
            cursor: pointer;
        }

        .upload-zone:hover, .upload-zone.drag-over {
            border-color: var(--primary-color);
            background-color: rgba(58, 134, 255, 0.05);
        }

        .upload-formats {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 1rem;
        }

        /* Footer Styles */
        .footer {
            padding: 1rem 2rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal {
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            padding: 1.5rem;
            flex: 1;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* Settings Styles */
        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-title {
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 1.125rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
        }

        .form-check {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .form-check-input {
            margin-right: 0.5rem;
        }

        .form-range {
            width: 100%;
        }

        .range-value {
            display: inline-block;
            margin-left: 0.5rem;
            font-weight: 500;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        /* Detection Settings */
        .detection-settings {
            background-color: var(--bg-tertiary);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }

        .detection-params {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .editor-content {
                flex-direction: column;
            }

            .crop-list {
                width: 100%;
                height: 200px;
                border-left: none;
                border-top: 1px solid var(--border-color);
            }

            .header {
                padding: 1rem;
            }

            .footer {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .detection-params {
                grid-template-columns: 1fr;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-1 {
            margin-top: 0.5rem;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        .mb-1 {
            margin-bottom: 0.5rem;
        }

        .mb-2 {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">BDC</div>
                <span>BatchDocCropper</span>
            </div>
            <div class="header-actions">
                <button class="btn-icon" id="theme-toggle" title="Toggle theme">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <button class="btn btn-secondary" id="settings-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    Settings
                </button>
                <button class="btn btn-primary" id="upload-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Upload Files
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h3>Files</h3>
                    <div class="file-counter" id="file-counter">0 / 50 files</div>
                </div>
                <div class="file-list" id="file-list">
                    <!-- File items will be dynamically added here -->
                </div>
            </div>

            <!-- Editor -->
            <div class="editor">
                <div class="editor-header">
                    <div class="editor-title" id="editor-title">No file selected</div>
                    <div class="editor-actions">
                        <button class="btn btn-secondary" id="detect-btn" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"></path>
                                <path d="M8.5 8.5v.01"></path>
                                <path d="M16 15.5v.01"></path>
                                <path d="M12 12v.01"></path>
                                <path d="M11 17v.01"></path>
                                <path d="M7 14v.01"></path>
                            </svg>
                            Detect Documents
                        </button>
                        <button class="btn btn-secondary" id="add-crop-btn" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                <line x1="8" y1="12" x2="16" y1="12"></line>
                            </svg>
                            Add Crop
                        </button>
                        <button class="btn btn-secondary" id="reset-crops-btn" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="1 4 1 10 7 10"></polyline>
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                            </svg>
                            Reset
                        </button>
                    </div>
                </div>
                <div class="editor-content">
                    <div class="canvas-container">
                        <canvas id="editor-canvas"></canvas>
                    </div>
                    <div class="crop-list">
                        <div class="crop-list-header">
                            <h3>Crops</h3>
                            <div id="crop-count">0 crops</div>
                        </div>
                        <div class="crop-items" id="crop-list">
                            <!-- Crop items will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Area (shown when no files are uploaded) -->
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </div>
                <h2 class="upload-title">Upload Your Files</h2>
                <p class="upload-description">
                    Drag and drop up to 50 images or PDFs. We'll auto-detect and crop documents/photos inside each page.
                    All processing happens in your browser. Files never leave your device.
                </p>
                <div class="upload-zone" id="upload-zone">
                    <div class="text-center">
                        <p>Drop files here or</p>
                        <button class="btn btn-primary mt-1" id="select-files-btn">Select Files</button>
                    </div>
                    <div class="upload-formats mt-2">
                        Supported formats: JPG, PNG, TIFF, PDF
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="summary" id="batch-summary">No files uploaded</div>
            <button class="btn btn-primary" id="download-btn" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download Cropped Images (ZIP)
            </button>
        </footer>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay hidden" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="modal-close" id="settings-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4 class="settings-title">AI Detection Settings</h4>
                    <div class="detection-settings">
                        <div class="form-group">
                            <label class="form-label" for="detection-sensitivity">Detection Sensitivity</label>
                            <input type="range" class="form-range" id="detection-sensitivity" min="1" max="10" value="6">
                            <div class="range-value" id="sensitivity-value">6</div>
                        </div>
                        <div class="detection-params">
                            <div class="form-group">
                                <label class="form-label" for="edge-threshold">Edge Threshold</label>
                                <input type="range" class="form-range" id="edge-threshold" min="10" max="100" value="50">
                                <div class="range-value" id="edge-value">50</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="min-doc-size">Min Document Size</label>
                                <input type="range" class="form-range" id="min-doc-size" min="5" max="50" value="15">
                                <div class="range-value" id="size-value">15%</div>
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="deskew-docs" checked>
                            <label class="form-label" for="deskew-docs">Auto-deskew documents</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enhance-docs" checked>
                            <label class="form-label" for="enhance-docs">Enhance document quality</label>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h4 class="settings-title">Output Settings</h4>
                    <div class="form-group">
                        <label class="form-label" for="output-format">Output Format</label>
                        <select class="form-select" id="output-format">
                            <option value="jpg">JPG</option>
                            <option value="png">PNG</option>
                        </select>
                    </div>
                    <div class="form-group" id="jpg-quality-group">
                        <label class="form-label" for="jpg-quality">JPG Quality <span class="range-value" id="jpg-quality-value">90</span>%</label>
                        <input type="range" class="form-range" id="jpg-quality" min="50" max="100" value="90">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="target-dpi">Target DPI</label>
                        <select class="form-select" id="target-dpi">
                            <option value="72">72 DPI (Screen)</option>
                            <option value="150">150 DPI</option>
                            <option value="300" selected>300 DPI (Print)</option>
                            <option value="600">600 DPI (High Quality)</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="auto-rotate" checked>
                        <label class="form-label" for="auto-rotate">Auto-rotate based on content</label>
                    </div>
                </div>

                <div class="settings-section">
                    <h4 class="settings-title">Processing Mode</h4>
                    <div class="form-group">
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="processing-mode" id="mode-document" checked>
                            <label class="form-label" for="mode-document">Document Mode (optimized for text, grayscale)</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="processing-mode" id="mode-photo">
                            <label class="form-label" for="mode-photo">Photo Mode (preserve colors)</label>
                        </div>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="shadow-cleanup">
                        <label class="form-label" for="shadow-cleanup">Clean shadows and background</label>
                    </div>
                </div>

                <div class="settings-section">
                    <h4 class="settings-title">File Naming</h4>
                    <div class="form-group">
                        <label class="form-label" for="filename-pattern">Filename Pattern</label>
                        <select class="form-select" id="filename-pattern">
                            <option value="{originalName}_{index}">{originalName}_{index}</option>
                            <option value="{batchName}_{fileIndex}_{cropIndex}">{batchName}_{fileIndex}_{cropIndex}</option>
                            <option value="{timestamp}_{index}">{timestamp}_{index}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="batch-prefix">Batch Prefix</label>
                        <input type="text" class="form-control" id="batch-prefix" placeholder="e.g., ScanBatch">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="settings-cancel">Cancel</button>
                <button class="btn btn-primary" id="settings-save">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- File Input (hidden) -->
    <input type="file" id="file-input" multiple accept=".jpg,.jpeg,.png,.tiff,.tif,.pdf" style="display: none;">

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        // Main application state
        const appState = {
            files: [],
            currentFileIndex: -1,
            crops: [],
            currentCropIndex: -1,
            isDrawing: false,
            startX: 0,
            startY: 0,
            settings: {
                outputFormat: 'jpg',
                jpgQuality: 90,
                targetDpi: 300,
                autoRotate: true,
                processingMode: 'document',
                shadowCleanup: false,
                filenamePattern: '{originalName}_{index}',
                batchPrefix: '',
                // AI Detection settings
                detectionSensitivity: 6,
                edgeThreshold: 50,
                minDocSize: 15,
                deskewDocs: true,
                enhanceDocs: true
            },
            theme: localStorage.getItem('theme') || 'light'
        };

        // DOM Elements
        const elements = {
            // Main containers
            uploadArea: document.getElementById('upload-area'),
            fileList: document.getElementById('file-list'),
            editorCanvas: document.getElementById('editor-canvas'),
            cropList: document.getElementById('crop-list'),
            
            // Buttons and controls
            themeToggle: document.getElementById('theme-toggle'),
            settingsBtn: document.getElementById('settings-btn'),
            uploadBtn: document.getElementById('upload-btn'),
            selectFilesBtn: document.getElementById('select-files-btn'),
            detectBtn: document.getElementById('detect-btn'),
            addCropBtn: document.getElementById('add-crop-btn'),
            resetCropsBtn: document.getElementById('reset-crops-btn'),
            downloadBtn: document.getElementById('download-btn'),
            fileInput: document.getElementById('file-input'),
            uploadZone: document.getElementById('upload-zone'),
            
            // Text elements
            fileCounter: document.getElementById('file-counter'),
            editorTitle: document.getElementById('editor-title'),
            cropCount: document.getElementById('crop-count'),
            batchSummary: document.getElementById('batch-summary'),
            
            // Settings modal
            settingsModal: document.getElementById('settings-modal'),
            settingsClose: document.getElementById('settings-close'),
            settingsCancel: document.getElementById('settings-cancel'),
            settingsSave: document.getElementById('settings-save'),
            
            // Settings form elements
            outputFormat: document.getElementById('output-format'),
            jpgQuality: document.getElementById('jpg-quality'),
            jpgQualityValue: document.getElementById('jpg-quality-value'),
            jpgQualityGroup: document.getElementById('jpg-quality-group'),
            targetDpi: document.getElementById('target-dpi'),
            autoRotate: document.getElementById('auto-rotate'),
            modeDocument: document.getElementById('mode-document'),
            modePhoto: document.getElementById('mode-photo'),
            shadowCleanup: document.getElementById('shadow-cleanup'),
            filenamePattern: document.getElementById('filename-pattern'),
            batchPrefix: document.getElementById('batch-prefix'),
            
            // AI Detection settings
            detectionSensitivity: document.getElementById('detection-sensitivity'),
            sensitivityValue: document.getElementById('sensitivity-value'),
            edgeThreshold: document.getElementById('edge-threshold'),
            edgeValue: document.getElementById('edge-value'),
            minDocSize: document.getElementById('min-doc-size'),
            sizeValue: document.getElementById('size-value'),
            deskewDocs: document.getElementById('deskew-docs'),
            enhanceDocs: document.getElementById('enhance-docs')
        };

        // Initialize the application
        function init() {
            // Set initial theme
            setTheme(appState.theme);
            
            // Load saved settings
            loadSettings();
            
            // Set up event listeners
            setupEventListeners();
            
            // Update UI based on initial state
            updateUI();
        }

        // Set up all event listeners
        function setupEventListeners() {
            // Theme toggle
            elements.themeToggle.addEventListener('click', toggleTheme);
            
            // File handling
            elements.uploadBtn.addEventListener('click', () => elements.fileInput.click());
            elements.selectFilesBtn.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', handleFileSelect);
            elements.uploadZone.addEventListener('dragover', handleDragOver);
            elements.uploadZone.addEventListener('dragleave', handleDragLeave);
            elements.uploadZone.addEventListener('drop', handleFileDrop);
            
            // Editor controls
            elements.detectBtn.addEventListener('click', detectDocuments);
            elements.addCropBtn.addEventListener('click', startManualCrop);
            elements.resetCropsBtn.addEventListener('click', resetCrops);
            elements.downloadBtn.addEventListener('click', downloadAllCrops);
            
            // Canvas events for crop creation and manipulation
            elements.editorCanvas.addEventListener('mousedown', startDrawing);
            elements.editorCanvas.addEventListener('mousemove', draw);
            elements.editorCanvas.addEventListener('mouseup', stopDrawing);
            elements.editorCanvas.addEventListener('touchstart', handleTouchStart);
            elements.editorCanvas.addEventListener('touchmove', handleTouchMove);
            elements.editorCanvas.addEventListener('touchend', handleTouchEnd);
            
            // Settings modal
            elements.settingsBtn.addEventListener('click', openSettings);
            elements.settingsClose.addEventListener('click', closeSettings);
            elements.settingsCancel.addEventListener('click', closeSettings);
            elements.settingsSave.addEventListener('click', saveSettings);
            
            // Settings form updates
            elements.outputFormat.addEventListener('change', updateJpgQualityVisibility);
            elements.jpgQuality.addEventListener('input', updateJpgQualityValue);
            
            // AI Detection settings
            elements.detectionSensitivity.addEventListener('input', updateSensitivityValue);
            elements.edgeThreshold.addEventListener('input', updateEdgeValue);
            elements.minDocSize.addEventListener('input', updateSizeValue);
        }

        // Theme handling
        function setTheme(theme) {
            appState.theme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }

        function toggleTheme() {
            const newTheme = appState.theme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }

        // File handling functions
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            processFiles(files);
            elements.fileInput.value = ''; // Reset file input
        }

        function handleDragOver(event) {
            event.preventDefault();
            elements.uploadZone.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            elements.uploadZone.classList.remove('drag-over');
        }

        function handleFileDrop(event) {
            event.preventDefault();
            elements.uploadZone.classList.remove('drag-over');
            const files = Array.from(event.dataTransfer.files);
            processFiles(files);
        }

        function processFiles(files) {
            // Validate file count
            if (appState.files.length + files.length > 50) {
                alert('You can upload a maximum of 50 files at a time.');
                files = files.slice(0, 50 - appState.files.length);
            }
            
            // Process each file
            files.forEach(file => {
                // Validate file type
                const validTypes = ['image/jpeg', 'image/png', 'image/tiff', 'application/pdf'];
                if (!validTypes.includes(file.type) && !file.name.match(/\.(jpg|jpeg|png|tiff|tif|pdf)$/i)) {
                    alert(`File "${file.name}" is not a supported format.`);
                    return;
                }
                
                // Create file object
                const fileObj = {
                    id: generateId(),
                    file: file,
                    name: file.name,
                    type: file.type,
                    status: 'waiting',
                    crops: [],
                    thumbnail: null,
                    width: 0,
                    height: 0,
                    imageData: null
                };
                
                appState.files.push(fileObj);
                
                // Generate thumbnail and process file
                generateThumbnail(fileObj);
            });
            
            // Update UI
            updateUI();
            
            // Auto-process the first file if none is selected
            if (appState.currentFileIndex === -1 && appState.files.length > 0) {
                selectFile(0);
            }
        }

        function generateThumbnail(fileObj) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Create thumbnail
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxSize = 50;
                    
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    fileObj.thumbnail = canvas.toDataURL('image/jpeg', 0.7);
                    fileObj.width = img.width;
                    fileObj.height = img.height;
                    
                    // Store the image data for processing
                    const fullCanvas = document.createElement('canvas');
                    fullCanvas.width = img.width;
                    fullCanvas.height = img.height;
                    const fullCtx = fullCanvas.getContext('2d');
                    fullCtx.drawImage(img, 0, 0);
                    fileObj.imageData = fullCtx.getImageData(0, 0, img.width, img.height);
                    
                    // Update file item in UI
                    updateFileItem(fileObj);
                };
                
                img.src = e.target.result;
            };
            
            if (fileObj.type === 'application/pdf') {
                // For PDFs, we'll just show a placeholder for now
                fileObj.thumbnail = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjRGN0ZBIi8+CjxwYXRoIGQ9Ik0xNSAxN0gzNVYzM0gxNVYxN1oiIGZpbGw9IiNBM0I4Q0QiLz4KPHBhdGggZD0iTTE1IDE3SDM1VjE5SDE1VjE3WiIgZmlsbD0iIzVBQjVFRCIvPgo8cGF0aCBkPSJNMjAgMjJIMzBWMjRIMjBWMjJaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMjAgMjZIMzBWMjhIMjBWMjZaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMjAgMzBIMzBWMzJIMjBWMzBaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K';
                fileObj.status = 'done';
                updateFileItem(fileObj);
            } else {
                reader.readAsDataURL(fileObj.file);
            }
        }

        function selectFile(index) {
            if (index < 0 || index >= appState.files.length) return;
            
            appState.currentFileIndex = index;
            const file = appState.files[index];
            
            // Update editor title
            elements.editorTitle.textContent = file.name;
            
            // Load image into canvas
            loadImageToCanvas(file);
            
            // Update crops list
            updateCropsList();
            
            // Enable/disable editor controls
            elements.detectBtn.disabled = false;
            elements.addCropBtn.disabled = false;
            elements.resetCropsBtn.disabled = false;
            
            // Update file list UI
            updateFileListUI();
        }

        function loadImageToCanvas(file) {
            const canvas = elements.editorCanvas;
            const ctx = canvas.getContext('2d');
            
            // Create a temporary image to get dimensions
            const img = new Image();
            img.onload = function() {
                // Set canvas dimensions to match image
                canvas.width = img.width;
                canvas.height = img.height;
                
                // Draw image on canvas
                ctx.drawImage(img, 0, 0);
                
                // Draw existing crop regions
                drawCropRegions();
            };
            
            if (file.file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file.file);
            } else if (file.thumbnail) {
                // For demo purposes, use thumbnail if file not available
                img.src = file.thumbnail;
            }
        }

        // AI-Powered Document Detection
        async function detectDocuments() {
            if (appState.currentFileIndex < 0) return;
            
            const file = appState.files[appState.currentFileIndex];
            file.status = 'processing';
            updateFileItem(file);
            
            try {
                // Simulate AI detection with mock results
                const mockCrops = generateMockCrops(file.width, file.height);
                
                file.crops = mockCrops;
                file.status = 'done';
                
                // Update current crops if this is the active file
                if (appState.files[appState.currentFileIndex]?.id === file.id) {
                    appState.crops = [...file.crops];
                    updateCropsList();
                    drawCropRegions();
                }
                
                updateFileItem(file);
                updateUI();
                
            } catch (error) {
                console.error('Document detection failed:', error);
                file.status = 'error';
                updateFileItem(file);
            }
        }

        function generateMockCrops(width, height) {
            const crops = [];
            const numCrops = Math.floor(Math.random() * 3) + 1; // 1-3 crops
            
            for (let i = 0; i < numCrops; i++) {
                // Generate random crop dimensions (between 30% and 70% of image size)
                const cropWidth = Math.floor(width * (0.3 + Math.random() * 0.4));
                const cropHeight = Math.floor(height * (0.3 + Math.random() * 0.4));
                
                // Generate random position
                const x = Math.floor(Math.random() * (width - cropWidth));
                const y = Math.floor(Math.random() * (height - cropHeight));
                
                crops.push({
                    id: generateId(),
                    name: `Document ${i + 1}`,
                    x: x,
                    y: y,
                    width: cropWidth,
                    height: cropHeight,
                    rotation: 0,
                    confidence: 0.7 + Math.random() * 0.3 // 0.7-1.0
                });
            }
            
            return crops;
        }

        // Crop creation and manipulation
        function startManualCrop() {
            appState.isDrawing = true;
            elements.editorCanvas.style.cursor = 'crosshair';
        }

        function startDrawing(e) {
            if (!appState.isDrawing) return;
            
            const canvas = elements.editorCanvas;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            appState.startX = (e.clientX - rect.left) * scaleX;
            appState.startY = (e.clientY - rect.top) * scaleY;
        }

        function draw(e) {
            if (!appState.isDrawing) return;
            
            const canvas = elements.editorCanvas;
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const currentX = (e.clientX - rect.left) * scaleX;
            const currentY = (e.clientY - rect.top) * scaleY;
            
            // Redraw the image
            const img = new Image();
            if (appState.files[appState.currentFileIndex]?.file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0);
                        drawCropRegions();
                        
                        // Draw the current selection rectangle
                        ctx.strokeStyle = '#3a86ff';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([5, 5]);
                        ctx.strokeRect(
                            appState.startX, 
                            appState.startY, 
                            currentX - appState.startX, 
                            currentY - appState.startY
                        );
                        ctx.setLineDash([]);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(appState.files[appState.currentFileIndex].file);
            }
        }

        function stopDrawing(e) {
            if (!appState.isDrawing) return;
            
            appState.isDrawing = false;
            elements.editorCanvas.style.cursor = 'default';
            
            const canvas = elements.editorCanvas;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const endX = (e.clientX - rect.left) * scaleX;
            const endY = (e.clientY - rect.top) * scaleY;
            
            // Calculate crop dimensions
            const x = Math.min(appState.startX, endX);
            const y = Math.min(appState.startY, endY);
            const width = Math.abs(endX - appState.startX);
            const height = Math.abs(endY - appState.startY);
            
            // Only create crop if it's large enough
            if (width > 10 && height > 10) {
                createCrop(x, y, width, height);
            }
            
            // Redraw without the selection rectangle
            drawCropRegions();
        }

        function createCrop(x, y, width, height) {
            const crop = {
                id: generateId(),
                name: `Crop ${appState.crops.length + 1}`,
                x: x,
                y: y,
                width: width,
                height: height,
                rotation: 0,
                confidence: 0.8
            };
            
            appState.crops.push(crop);
            
            // Also add to the current file
            if (appState.currentFileIndex >= 0) {
                appState.files[appState.currentFileIndex].crops.push(crop);
            }
            
            updateCropsList();
            drawCropRegions();
        }

        function drawCropRegions() {
            const canvas = elements.editorCanvas;
            const ctx = canvas.getContext('2d');
            
            // Redraw the image
            const img = new Image();
            if (appState.files[appState.currentFileIndex]?.file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0);
                        
                        // Draw each crop region
                        appState.crops.forEach((crop, index) => {
                            ctx.strokeStyle = index === appState.currentCropIndex ? '#ef476f' : '#3a86ff';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(crop.x, crop.y, crop.width, crop.height);
                            
                            // Draw corner handles
                            const handleSize = 8;
                            ctx.fillStyle = index === appState.currentCropIndex ? '#ef476f' : '#3a86ff';
                            
                            // Top-left
                            ctx.fillRect(crop.x - handleSize/2, crop.y - handleSize/2, handleSize, handleSize);
                            // Top-right
                            ctx.fillRect(crop.x + crop.width - handleSize/2, crop.y - handleSize/2, handleSize, handleSize);
                            // Bottom-left
                            ctx.fillRect(crop.x - handleSize/2, crop.y + crop.height - handleSize/2, handleSize, handleSize);
                            // Bottom-right
                            ctx.fillRect(crop.x + crop.width - handleSize/2, crop.y + crop.height - handleSize/2, handleSize, handleSize);
                            
                            // Draw confidence score
                            ctx.fillStyle = '#3a86ff';
                            ctx.font = '12px Arial';
                            ctx.fillText(`${Math.round(crop.confidence * 100)}%`, crop.x + 5, crop.y + 15);
                        });
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(appState.files[appState.currentFileIndex].file);
            }
        }

        function resetCrops() {
            if (appState.currentFileIndex >= 0) {
                appState.files[appState.currentFileIndex].crops = [];
                appState.crops = [];
                updateCropsList();
                drawCropRegions();
            }
        }

        // Touch event handlers for mobile
        function handleTouchStart(e) {
            if (!appState.isDrawing) return;
            
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            elements.editorCanvas.dispatchEvent(mouseEvent);
        }

        function handleTouchMove(e) {
            if (!appState.isDrawing) return;
            
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            elements.editorCanvas.dispatchEvent(mouseEvent);
        }

        function handleTouchEnd(e) {
            if (!appState.isDrawing) return;
            
            e.preventDefault();
            const mouseEvent = new MouseEvent('mouseup', {});
            elements.editorCanvas.dispatchEvent(mouseEvent);
        }

        // Settings functions
        function openSettings() {
            // Populate form with current settings
            elements.outputFormat.value = appState.settings.outputFormat;
            elements.jpgQuality.value = appState.settings.jpgQuality;
            elements.jpgQualityValue.textContent = appState.settings.jpgQuality;
            elements.targetDpi.value = appState.settings.targetDpi;
            elements.autoRotate.checked = appState.settings.autoRotate;
            
            if (appState.settings.processingMode === 'document') {
                elements.modeDocument.checked = true;
            } else {
                elements.modePhoto.checked = true;
            }
            
            elements.shadowCleanup.checked = appState.settings.shadowCleanup;
            elements.filenamePattern.value = appState.settings.filenamePattern;
            elements.batchPrefix.value = appState.settings.batchPrefix;
            
            // AI Detection settings
            elements.detectionSensitivity.value = appState.settings.detectionSensitivity;
            elements.sensitivityValue.textContent = appState.settings.detectionSensitivity;
            elements.edgeThreshold.value = appState.settings.edgeThreshold;
            elements.edgeValue.textContent = appState.settings.edgeThreshold;
            elements.minDocSize.value = appState.settings.minDocSize;
            elements.sizeValue.textContent = appState.settings.minDocSize + '%';
            elements.deskewDocs.checked = appState.settings.deskewDocs;
            elements.enhanceDocs.checked = appState.settings.enhanceDocs;
            
            // Update JPG quality visibility
            updateJpgQualityVisibility();
            
            // Show modal
            elements.settingsModal.classList.remove('hidden');
        }

        function closeSettings() {
            elements.settingsModal.classList.add('hidden');
        }

        function saveSettings() {
            // Save settings from form
            appState.settings.outputFormat = elements.outputFormat.value;
            appState.settings.jpgQuality = parseInt(elements.jpgQuality.value);
            appState.settings.targetDpi = parseInt(elements.targetDpi.value);
            appState.settings.autoRotate = elements.autoRotate.checked;
            appState.settings.processingMode = elements.modeDocument.checked ? 'document' : 'photo';
            appState.settings.shadowCleanup = elements.shadowCleanup.checked;
            appState.settings.filenamePattern = elements.filenamePattern.value;
            appState.settings.batchPrefix = elements.batchPrefix.value;
            
            // AI Detection settings
            appState.settings.detectionSensitivity = parseInt(elements.detectionSensitivity.value);
            appState.settings.edgeThreshold = parseInt(elements.edgeThreshold.value);
            appState.settings.minDocSize = parseInt(elements.minDocSize.value);
            appState.settings.deskewDocs = elements.deskewDocs.checked;
            appState.settings.enhanceDocs = elements.enhanceDocs.checked;
            
            // Save to localStorage
            localStorage.setItem('batchDocCropperSettings', JSON.stringify(appState.settings));
            
            // Close modal
            closeSettings();
            
            // Update UI to reflect new settings
            updateUI();
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('batchDocCropperSettings');
            if (savedSettings) {
                appState.settings = { ...appState.settings, ...JSON.parse(savedSettings) };
            }
        }

        function updateJpgQualityVisibility() {
            if (elements.outputFormat.value === 'jpg') {
                elements.jpgQualityGroup.style.display = 'block';
            } else {
                elements.jpgQualityGroup.style.display = 'none';
            }
        }

        function updateJpgQualityValue() {
            elements.jpgQualityValue.textContent = elements.jpgQuality.value;
        }

        // AI Detection settings handlers
        function updateSensitivityValue() {
            elements.sensitivityValue.textContent = elements.detectionSensitivity.value;
        }

        function updateEdgeValue() {
            elements.edgeValue.textContent = elements.edgeThreshold.value;
        }

        function updateSizeValue() {
            elements.sizeValue.textContent = elements.minDocSize.value + '%';
        }

        // Download functionality
        function downloadAllCrops() {
            // Create a ZIP file containing all crops from all files
            const zip = new JSZip();
            let cropCount = 0;
            
            // Process each file
            appState.files.forEach(file => {
                if (file.crops.length > 0) {
                    // For each crop in the file
                    file.crops.forEach((crop, index) => {
                        // Generate filename based on pattern
                        const filename = generateFilename(file, crop, index);
                        
                        // Create a canvas for the crop
                        const canvas = document.createElement('canvas');
                        canvas.width = crop.width;
                        canvas.height = crop.height;
                        const ctx = canvas.getContext('2d');
                        
                        // Fill with a placeholder color (in real implementation, this would be the actual crop)
                        ctx.fillStyle = '#f0f0f0';
                        ctx.fillRect(0, 0, crop.width, crop.height);
                        
                        // Add crop border and label for demo
                        ctx.strokeStyle = '#3a86ff';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(0, 0, crop.width, crop.height);
                        
                        ctx.fillStyle = '#3a86ff';
                        ctx.font = '16px Arial';
                        ctx.fillText(`Crop ${index + 1}`, 10, 30);
                        ctx.fillText(`${crop.width}  ${crop.height}`, 10, 50);
                        
                        // Convert to data URL and add to ZIP
                        const dataUrl = canvas.toDataURL(`image/${appState.settings.outputFormat}`, 
                            appState.settings.outputFormat === 'jpg' ? appState.settings.jpgQuality / 100 : 1);
                        
                        // Extract base64 data from data URL
                        const base64Data = dataUrl.split(',')[1];
                        
                        // Add to ZIP
                        zip.file(filename, base64Data, { base64: true });
                        cropCount++;
                    });
                }
            });
            
            // Generate ZIP and trigger download
            zip.generateAsync({ type: 'blob' }).then(function(content) {
                saveAs(content, `BatchDocCropper_${new Date().toISOString().slice(0, 10)}.zip`);
            });
        }

        function generateFilename(file, crop, index) {
            let filename = appState.settings.filenamePattern;
            
            // Replace placeholders with actual values
            filename = filename.replace(/{originalName}/g, file.name.replace(/\.[^/.]+$/, ""));
            filename = filename.replace(/{index}/g, (index + 1).toString().padStart(3, '0'));
            filename = filename.replace(/{fileIndex}/g, (appState.files.indexOf(file) + 1).toString().padStart(2, '0'));
            filename = filename.replace(/{cropIndex}/g, (index + 1).toString().padStart(3, '0'));
            filename = filename.replace(/{batchName}/g, appState.settings.batchPrefix || 'batch');
            filename = filename.replace(/{timestamp}/g, new Date().toISOString().slice(0, 10));
            
            // Add file extension
            filename += `.${appState.settings.outputFormat}`;
            
            return filename;
        }

        // UI update functions
        function updateUI() {
            // Update file counter
            elements.fileCounter.textContent = `${appState.files.length} / 50 files`;
            
            // Update batch summary
            const totalCrops = appState.files.reduce((sum, file) => sum + file.crops.length, 0);
            elements.batchSummary.textContent = 
                `${appState.files.length} files, ${totalCrops} crops ready  Output: ${appState.settings.outputFormat.toUpperCase()}, quality ${appState.settings.jpgQuality}, ${appState.settings.targetDpi} DPI`;
            
            // Show/hide upload area
            if (appState.files.length === 0) {
                elements.uploadArea.classList.remove('hidden');
            } else {
                elements.uploadArea.classList.add('hidden');
            }
            
            // Enable/disable download button
            elements.downloadBtn.disabled = totalCrops === 0;
            
            // Update file list
            updateFileListUI();
        }

        function updateFileListUI() {
            elements.fileList.innerHTML = '';
            
            appState.files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = `file-item ${index === appState.currentFileIndex ? 'active' : ''}`;
                fileItem.addEventListener('click', () => selectFile(index));
                
                fileItem.innerHTML = `
                    <div class="file-thumbnail">
                        ${file.thumbnail ? `<img src="${file.thumbnail}" alt="${file.name}">` : ''}
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-details">
                            <span>${file.width}  ${file.height}</span>
                            <div class="file-status">
                                <span class="status-badge status-${file.status}">${file.status}</span>
                                ${file.crops.length > 0 ? `<span>${file.crops.length} crops</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                elements.fileList.appendChild(fileItem);
            });
        }

        function updateFileItem(file) {
            // In a real implementation, we would update the specific file item
            // For this demo, we'll just refresh the entire list
            updateFileListUI();
        }

        function updateCropsList() {
            elements.cropList.innerHTML = '';
            elements.cropCount.textContent = `${appState.crops.length} crops`;
            
            appState.crops.forEach((crop, index) => {
                const cropItem = document.createElement('div');
                cropItem.className = `crop-item ${index === appState.currentCropIndex ? 'active' : ''}`;
                cropItem.addEventListener('click', () => selectCrop(index));
                
                // Create a thumbnail for the crop
                const canvas = document.createElement('canvas');
                canvas.width = 50;
                canvas.height = 50;
                const ctx = canvas.getContext('2d');
                
                // Fill with a placeholder
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, 50, 50);
                
                // Add a border
                ctx.strokeStyle = '#3a86ff';
                ctx.lineWidth = 1;
                ctx.strokeRect(0, 0, 50, 50);
                
                // Add crop info
                ctx.fillStyle = '#3a86ff';
                ctx.font = '8px Arial';
                ctx.fillText(`${Math.round(crop.confidence * 100)}%`, 5, 10);
                
                cropItem.innerHTML = `
                    <div class="crop-thumbnail">
                        <canvas width="50" height="50"></canvas>
                    </div>
                    <div class="crop-info">
                        <div class="crop-name">${crop.name}</div>
                        <div class="crop-details">${Math.round(crop.width)}  ${Math.round(crop.height)}</div>
                    </div>
                    <div class="crop-actions">
                        <button class="btn-icon" title="Delete crop">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                `;
                
                // Replace the canvas with our generated one
                const thumbnail = cropItem.querySelector('.crop-thumbnail');
                thumbnail.innerHTML = '';
                thumbnail.appendChild(canvas);
                
                // Add delete event listener
                const deleteBtn = cropItem.querySelector('.crop-actions .btn-icon');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteCrop(index);
                });
                
                elements.cropList.appendChild(cropItem);
            });
        }

        function selectCrop(index) {
            appState.currentCropIndex = index;
            updateCropsList();
            drawCropRegions();
        }

        function deleteCrop(index) {
            appState.crops.splice(index, 1);
            
            // Also remove from current file
            if (appState.currentFileIndex >= 0) {
                const file = appState.files[appState.currentFileIndex];
                const cropId = appState.crops[index]?.id;
                if (cropId) {
                    file.crops = file.crops.filter(c => c.id !== cropId);
                }
            }
            
            // Reset selection
            appState.currentCropIndex = -1;
            
            updateCropsList();
            drawCropRegions();
            updateUI();
        }

        // Utility functions
        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Initialize the app when the DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
