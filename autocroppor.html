<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BatchDocCropper - AI-Powered Document Cropping</title>
    <style>
        :root {
            --primary-color: #3a86ff;
            --primary-dark: #2667cc;
            --secondary-color: #8338ec;
            --success-color: #06d6a0;
            --warning-color: #ffd166;
            --error-color: #ef476f;
            --bg-color: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-color: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2d2d2d;
            --text-color: #e9ecef;
            --text-secondary: #adb5bd;
            --border-color: #404040;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: var(--transition);
        }

        .app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background-color: var(--primary-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-icon {
            padding: 0.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .btn-icon:hover {
            background-color: var(--bg-tertiary);
        }

        /* Main Content Styles */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 300px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .file-counter {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .file-item {
            display: flex;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .file-item:hover {
            background-color: var(--bg-tertiary);
        }

        .file-item.active {
            border-color: var(--primary-color);
            background-color: rgba(58, 134, 255, 0.1);
        }

        .file-thumbnail {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            background-color: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .file-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .file-info {
            flex: 1;
            overflow: hidden;
        }

        .file-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }

        .file-details {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        .file-status {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
        }

        .status-badge {
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.625rem;
            font-weight: 500;
        }

        .status-waiting {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .status-processing {
            background-color: var(--warning-color);
            color: #000;
        }

        .status-done {
            background-color: var(--success-color);
            color: white;
        }

        .status-error {
            background-color: var(--error-color);
            color: white;
        }

        /* Editor Styles */
        .editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-title {
            font-weight: 600;
        }

        .editor-actions {
            display: flex;
            gap: 0.5rem;
        }

        .editor-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            padding: 1rem;
            background-color: var(--bg-tertiary);
            position: relative;
        }

        #editor-canvas {
            max-width: 100%;
            max-height: 100%;
            box-shadow: var(--shadow);
            background-color: white;
            cursor: crosshair;
        }

        .crop-list {
            width: 250px;
            border-left: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .crop-list-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .crop-items {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .crop-item {
            display: flex;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .crop-item:hover {
            background-color: var(--bg-tertiary);
        }

        .crop-item.active {
            border-color: var(--primary-color);
            background-color: rgba(58, 134, 255, 0.1);
        }

        .crop-thumbnail {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            background-color: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .crop-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .crop-info {
            flex: 1;
            overflow: hidden;
        }

        .crop-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .crop-details {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .crop-actions {
            display: flex;
            gap: 0.25rem;
        }

        /* Upload Area Styles */
        .upload-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            background-color: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            font-size: 2rem;
        }

        .upload-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .upload-description {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            max-width: 500px;
        }

        .upload-zone {
            width: 100%;
            max-width: 500px;
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 2rem;
            transition: var(--transition);
            cursor: pointer;
        }

        .upload-zone:hover, .upload-zone.drag-over {
            border-color: var(--primary-color);
            background-color: rgba(58, 134, 255, 0.05);
        }

        .upload-formats {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 1rem;
        }

        /* Footer Styles */
        .footer {
            padding: 1rem 2rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal {
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            padding: 1.5rem;
            flex: 1;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* Settings Styles */
        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-title {
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 1.125rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
        }

        .form-check {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .form-check-input {
            margin-right: 0.5rem;
        }

        .form-range {
            width: 100%;
        }

        .range-value {
            display: inline-block;
            margin-left: 0.5rem;
            font-weight: 500;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        /* Detection Settings */
        .detection-settings {
            background-color: var(--bg-tertiary);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }

        .detection-params {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .editor-content {
                flex-direction: column;
            }

            .crop-list {
                width: 100%;
                height: 200px;
                border-left: none;
                border-top: 1px solid var(--border-color);
            }

            .header {
                padding: 1rem;
            }

            .footer {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .detection-params {
                grid-template-columns: 1fr;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-1 {
            margin-top: 0.5rem;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        .mb-1 {
            margin-bottom: 0.5rem;
        }

        .mb-2 {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">BDC</div>
                <span>BatchDocCropper</span>
            </div>
            <div class="header-actions">
                <button class="btn-icon" id="theme-toggle" title="Toggle theme">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <button class="btn btn-secondary" id="settings-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    Settings
                </button>
                <button class="btn btn-primary" id="upload-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Upload Files
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h3>Files</h3>
                    <div class="file-counter" id="file-counter">0 / 50 files</div>
                </div>
                <div class="file-list" id="file-list">
                    <!-- File items will be dynamically added here -->
                </div>
            </div>

            <!-- Editor -->
            <div class="editor">
                <div class="editor-header">
                    <div class="editor-title" id="editor-title">No file selected</div>
                    <div class="editor-actions">
                        <button class="btn btn-secondary" id="detect-btn" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"></path>
                                <path d="M8.5 8.5v.01"></path>
                                <path d="M16 15.5v.01"></path>
                                <path d="M12 12v.01"></path>
                                <path d="M11 17v.01"></path>
                                <path d="M7 14v.01"></path>
                            </svg>
                            Detect Documents
                        </button>
                        <button class="btn btn-secondary" id="add-crop-btn" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                <line x1="8" y1="12" x2="16" y1="12"></line>
                            </svg>
                            Add Crop
                        </button>
                        <button class="btn btn-secondary" id="reset-crops-btn" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="1 4 1 10 7 10"></polyline>
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                            </svg>
                            Reset
                        </button>
                    </div>
                </div>
                <div class="editor-content">
                    <div class="canvas-container">
                        <canvas id="editor-canvas"></canvas>
                    </div>
                    <div class="crop-list">
                        <div class="crop-list-header">
                            <h3>Crops</h3>
                            <div id="crop-count">0 crops</div>
                        </div>
                        <div class="crop-items" id="crop-list">
                            <!-- Crop items will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Area (shown when no files are uploaded) -->
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </div>
                <h2 class="upload-title">Upload Your Files</h2>
                <p class="upload-description">
                    Drag and drop up to 50 images or PDFs. We'll auto-detect and crop documents/photos inside each page.
                    All processing happens in your browser. Files never leave your device.
                </p>
                <div class="upload-zone" id="upload-zone">
                    <div class="text-center">
                        <p>Drop files here or</p>
                        <button class="btn btn-primary mt-1" id="select-files-btn">Select Files</button>
                    </div>
                    <div class="upload-formats mt-2">
                        Supported formats: JPG, PNG, TIFF, PDF
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="summary" id="batch-summary">No files uploaded</div>
            <button class="btn btn-primary" id="download-btn" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download Cropped Images (ZIP)
            </button>
        </footer>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay hidden" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="modal-close" id="settings-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4 class="settings-title">AI Detection Settings</h4>
                    <div class="detection-settings">
                        <div class="form-group">
                            <label class="form-label" for="detection-sensitivity">Detection Sensitivity</label>
                            <input type="range" class="form-range" id="detection-sensitivity" min="1" max="10" value="6">
                            <div class="range-value" id="sensitivity-value">6</div>
                        </div>
                        <div class="detection-params">
                            <div class="form-group">
                                <label class="form-label" for="edge-threshold">Edge Threshold</label>
                                <input type="range" class="form-range" id="edge-threshold" min="10" max="100" value="50">
                                <div class="range-value" id="edge-value">50</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="min-doc-size">Min Document Size</label>
                                <input type="range" class="form-range" id="min-doc-size" min="5" max="50" value="15">
                                <div class="range-value" id="size-value">15%</div>
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="deskew-docs" checked>
                            <label class="form-label" for="deskew-docs">Auto-deskew documents</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enhance-docs" checked>
                            <label class="form-label" for="enhance-docs">Enhance document quality</label>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h4 class="settings-title">Output Settings</h4>
                    <div class="form-group">
                        <label class="form-label" for="output-format">Output Format</label>
                        <select class="form-select" id="output-format">
                            <option value="jpg">JPG</option>
                            <option value="png">PNG</option>
                        </select>
                    </div>
                    <div class="form-group" id="jpg-quality-group">
                        <label class="form-label" for="jpg-quality">JPG Quality <span class="range-value" id="jpg-quality-value">90</span>%</label>
                        <input type="range" class="form-range" id="jpg-quality" min="50" max="100" value="90">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="target-dpi">Target DPI</label>
                        <select class="form-select" id="target-dpi">
                            <option value="72">72 DPI (Screen)</option>
                            <option value="150">150 DPI</option>
                            <option value="300" selected>300 DPI (Print)</option>
                            <option value="600">600 DPI (High Quality)</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="auto-rotate" checked>
                        <label class="form-label" for="auto-rotate">Auto-rotate based on content</label>
                    </div>
                </div>

                <div class="settings-section">
                    <h4 class="settings-title">Processing Mode</h4>
                    <div class="form-group">
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="processing-mode" id="mode-document" checked>
                            <label class="form-label" for="mode-document">Document Mode (optimized for text, grayscale)</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="processing-mode" id="mode-photo">
                            <label class="form-label" for="mode-photo">Photo Mode (preserve colors)</label>
                        </div>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="shadow-cleanup">
                        <label class="form-label" for="shadow-cleanup">Clean shadows and background</label>
                    </div>
                </div>

                <div class="settings-section">
                    <h4 class="settings-title">File Naming</h4>
                    <div class="form-group">
                        <label class="form-label" for="filename-pattern">Filename Pattern</label>
                        <select class="form-select" id="filename-pattern">
                            <option value="{originalName}_{index}">{originalName}_{index}</option>
                            <option value="{batchName}_{fileIndex}_{cropIndex}">{batchName}_{fileIndex}_{cropIndex}</option>
                            <option value="{timestamp}_{index}">{timestamp}_{index}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="batch-prefix">Batch Prefix</label>
                        <input type="text" class="form-control" id="batch-prefix" placeholder="e.g., ScanBatch">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="settings-cancel">Cancel</button>
                <button class="btn btn-primary" id="settings-save">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- File Input (hidden) -->
    <input type="file" id="file-input" multiple accept=".jpg,.jpeg,.png,.tiff,.tif,.pdf" style="display: none;">

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        // Advanced Document Detection Algorithm
        class DocumentDetector {
            constructor() {
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.worker = this.createWorker();
            }

            createWorker() {
                // Create a web worker for heavy computation
                const blob = new Blob([`
                    self.onmessage = function(e) {
                        const { imageData, width, height, sensitivity, edgeThreshold, minSize } = e.data;
                        const result = detectDocuments(imageData, width, height, sensitivity, edgeThreshold, minSize);
                        self.postMessage(result);
                    };

                    function detectDocuments(imageData, width, height, sensitivity, edgeThreshold, minSize) {
                        const data = new Uint32Array(imageData);
                        const edges = detectEdges(data, width, height, edgeThreshold);
                        const contours = findContours(edges, width, height);
                        const documents = filterDocuments(contours, width, height, sensitivity, minSize);
                        return documents;
                    }

                    function detectEdges(data, width, height, threshold) {
                        const edges = new Uint8Array(width * height);
                        const sobelX = [-1, 0, 1, -2, 0, 2, -1, 0, 1];
                        const sobelY = [-1, -2, -1, 0, 0, 0, 1, 2, 1];
                        
                        for (let y = 1; y < height - 1; y++) {
                            for (let x = 1; x < width - 1; x++) {
                                let gx = 0, gy = 0;
                                
                                for (let ky = -1; ky <= 1; ky++) {
                                    for (let kx = -1; kx <= 1; kx++) {
                                        const pixel = data[(y + ky) * width + (x + kx)];
                                        const r = (pixel >> 16) & 0xff;
                                        const g = (pixel >> 8) & 0xff;
                                        const b = pixel & 0xff;
                                        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                                        
                                        const kernelIndex = (ky + 1) * 3 + (kx + 1);
                                        gx += gray * sobelX[kernelIndex];
                                        gy += gray * sobelY[kernelIndex];
                                    }
                                }
                                
                                const magnitude = Math.sqrt(gx * gx + gy * gy);
                                edges[y * width + x] = magnitude > threshold ? 255 : 0;
                            }
                        }
                        return edges;
                    }

                    function findContours(edges, width, height) {
                        const visited = new Uint8Array(width * height);
                        const contours = [];
                        
                        for (let y = 0; y < height; y++) {
                            for (let x = 0; x < width; x++) {
                                if (edges[y * width + x] === 255 && !visited[y * width + x]) {
                                    const contour = traceContour(edges, visited, x, y, width, height);
                                    if (contour.length > 10) {
                                        contours.push(contour);
                                    }
                                }
                            }
                        }
                        return contours;
                    }

                    function traceContour(edges, visited, startX, startY, width, height) {
                        const contour = [];
                        const stack = [[startX, startY]];
                        const directions = [[1,0], [1,1], [0,1], [-1,1], [-1,0], [-1,-1], [0,-1], [1,-1]];
                        
                        while (stack.length > 0) {
                            const [x, y] = stack.pop();
                            if (x < 0 || x >= width || y < 0 || y >= height) continue;
                            if (visited[y * width + x] || edges[y * width + x] !== 255) continue;
                            
                            visited[y * width + x] = 1;
                            contour.push([x, y]);
                            
                            for (const [dx, dy] of directions) {
                                stack.push([x + dx, y + dy]);
                            }
                        }
                        return contour;
                    }

                    function filterDocuments(contours, width, height, sensitivity, minSize) {
                        const documents = [];
                        const minArea = (width * height * minSize) / 10000;
                        
                        for (const contour of contours) {
                            if (contour.length < 4) continue;
                            
                            const rect = approximateRectangle(contour);
                            if (!rect) continue;
                            
                            const area = rect.width * rect.height;
                            if (area < minArea) continue;
                            
                            const aspectRatio = Math.max(rect.width, rect.height) / Math.min(rect.width, rect.height);
                            if (aspectRatio > 5) continue; // Too elongated
                            
                            const rectangularity = area / (rect.width * rect.height);
                            if (rectangularity < 0.7) continue;
                            
                            // Calculate confidence based on various factors
                            const confidence = calculateConfidence(contour, rect, sensitivity);
                            
                            if (confidence > 0.5) {
                                documents.push({
                                    x: rect.x,
                                    y: rect.y,
                                    width: rect.width,
                                    height: rect.height,
                                    rotation: rect.rotation,
                                    confidence: confidence
                                });
                            }
                        }
                        
                        return documents.sort((a, b) => b.confidence - a.confidence);
                    }

                    function approximateRectangle(contour) {
                        if (contour.length < 4) return null;
                        
                        // Simple bounding box approximation
                        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                        for (const [x, y] of contour) {
                            minX = Math.min(minX, x);
                            minY = Math.min(minY, y);
                            maxX = Math.max(maxX, x);
                            maxY = Math.max(maxY, y);
                        }
                        
                        return {
                            x: minX,
                            y: minY,
                            width: maxX - minX,
                            height: maxY - minY,
                            rotation: 0
                        };
                    }

                    function calculateConfidence(contour, rect, sensitivity) {
                        const area = rect.width * rect.height;
                        const contourArea = contour.length;
                        const coverage = contourArea / (2 * (rect.width + rect.height));
                        
                        // Higher sensitivity means lower threshold for detection
                        const baseConfidence = Math.min(1, coverage * (sensitivity / 5));
                        return baseConfidence;
                    }
                `], { type: 'application/javascript' });
                
                return new Worker(URL.createObjectURL(blob));
            }

            async detectDocuments(image, sensitivity = 6, edgeThreshold = 50, minSize = 15) {
                return new Promise((resolve) => {
                    // Set canvas dimensions
                    this.canvas.width = image.width;
                    this.canvas.height = image.height;
                    
                    // Draw image on canvas
                    this.ctx.drawImage(image, 0, 0);
                    
                    // Get image data
                    const imageData = this.ctx.getImageData(0, 0, image.width, image.height);
                    
                    // Use worker for detection
                    this.worker.postMessage({
                        imageData: imageData.data.buffer,
                        width: image.width,
                        height: image.height,
                        sensitivity: sensitivity,
                        edgeThreshold: edgeThreshold,
                        minSize: minSize
                    }, [imageData.data.buffer]);
                    
                    this.worker.onmessage = (e) => {
                        resolve(e.data);
                    };
                });
            }

            destroy() {
                this.worker.terminate();
            }
        }

        // Enhanced Image Processor with Deskew and Enhancement
        class ImageProcessor {
            static deskewImage(ctx, x, y, width, height, rotation) {
                ctx.save();
                ctx.translate(x + width / 2, y + height / 2);
                ctx.rotate(rotation * Math.PI / 180);
                ctx.translate(-width / 2, -height / 2);
                return ctx;
            }

            static enhanceDocument(ctx, width, height, mode) {
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    if (mode === 'document') {
                        // Convert to grayscale and enhance contrast for documents
                        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                        const enhanced = this.enhanceContrast(gray, 50, 200);
                        data[i] = data[i + 1] = data[i + 2] = enhanced;
                    } else {
                        // Enhance colors for photos
                        data[i] = this.enhanceColor(data[i]);
                        data[i + 1] = this.enhanceColor(data[i + 1]);
                        data[i + 2] = this.enhanceColor(data[i + 2]);
                    }
                    
                    // Remove shadows by lightening dark pixels
                    if (data[i] < 50 && data[i + 1] < 50 && data[i + 2] < 50) {
                        const factor = 2;
                        data[i] = Math.min(255, data[i] * factor);
                        data[i + 1] = Math.min(255, data[i + 1] * factor);
                        data[i + 2] = Math.min(255, data[i + 2] * factor);
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
                return ctx;
            }

            static enhanceContrast(value, min, max) {
                return Math.min(255, Math.max(0, (value - min) * 255 / (max - min)));
            }

            static enhanceColor(value) {
                // S-curve contrast enhancement
                return 255 * (1 / (1 + Math.exp(-(value - 128) / 32)));
            }

            static removeBackground(ctx, width, height) {
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                // Simple background removal by detecting dominant color
                const histogram = new Array(256).fill(0);
                for (let i = 0; i < data.length; i += 4) {
                    const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    histogram[Math.floor(gray)]++;
                }
                
                // Find dominant background color
                let maxCount = 0;
                let bgColor = 0;
                for (let i = 0; i < 256; i++) {
                    if (histogram[i] > maxCount) {
                        maxCount = histogram[i];
                        bgColor = i;
                    }
                }
                
                // Replace background with white
                for (let i = 0; i < data.length; i += 4) {
                    const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    if (Math.abs(gray - bgColor) < 30) {
                        data[i] = data[i + 1] = data[i + 2] = 255;
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
                return ctx;
            }
        }

        // Main application state
        const appState = {
            files: [],
            currentFileIndex: -1,
            crops: [],
            currentCropIndex: -1,
            isDrawing: false,
            startX: 0,
            startY: 0,
            detector: new DocumentDetector(),
            settings: {
                outputFormat: 'jpg',
                jpgQuality: 90,
                targetDpi: 300,
                autoRotate: true,
                processingMode: 'document',
                shadowCleanup: false,
                filenamePattern: '{originalName}_{index}',
                batchPrefix: '',
                // AI Detection settings
                detectionSensitivity: 6,
                edgeThreshold: 50,
                minDocSize: 15,
                deskewDocs: true,
                enhanceDocs: true
            },
            theme: localStorage.getItem('theme') || 'light'
        };

        // DOM Elements
        const elements = {
            // Main containers
            uploadArea: document.getElementById('upload-area'),
            fileList: document.getElementById('file-list'),
            editorCanvas: document.getElementById('editor-canvas'),
            cropList: document.getElementById('crop-list'),
            
            // Buttons and controls
            themeToggle: document.getElementById('theme-toggle'),
            settingsBtn: document.getElementById('settings-btn'),
            uploadBtn: document.getElementById('upload-btn'),
            selectFilesBtn: document.getElementById('select-files-btn'),
            detectBtn: document.getElementById('detect-btn'),
            addCropBtn: document.getElementById('add-crop-btn'),
            resetCropsBtn: document.getElementById('reset-crops-btn'),
            downloadBtn: document.getElementById('download-btn'),
            fileInput: document.getElementById('file-input'),
            uploadZone: document.getElementById('upload-zone'),
            
            // Text elements
            fileCounter: document.getElementById('file-counter'),
            editorTitle: document.getElementById('editor-title'),
            cropCount: document.getElementById('crop-count'),
            batchSummary: document.getElementById('batch-summary'),
            
            // Settings modal
            settingsModal: document.getElementById('settings-modal'),
            settingsClose: document.getElementById('settings-close'),
            settingsCancel: document.getElementById('settings-cancel'),
            settingsSave: document.getElementById('settings-save'),
            
            // Settings form elements
            outputFormat: document.getElementById('output-format'),
            jpgQuality: document.getElementById('jpg-quality'),
            jpgQualityValue: document.getElementById('jpg-quality-value'),
            jpgQualityGroup: document.getElementById('jpg-quality-group'),
            targetDpi: document.getElementById('target-dpi'),
            autoRotate: document.getElementById('auto-rotate'),
            modeDocument: document.getElementById('mode-document'),
            modePhoto: document.getElementById('mode-photo'),
            shadowCleanup: document.getElementById('shadow-cleanup'),
            filenamePattern: document.getElementById('filename-pattern'),
            batchPrefix: document.getElementById('batch-prefix'),
            
            // AI Detection settings
            detectionSensitivity: document.getElementById('detection-sensitivity'),
            sensitivityValue: document.getElementById('sensitivity-value'),
            edgeThreshold: document.getElementById('edge-threshold'),
            edgeValue: document.getElementById('edge-value'),
            minDocSize: document.getElementById('min-doc-size'),
            sizeValue: document.getElementById('size-value'),
            deskewDocs: document.getElementById('deskew-docs'),
            enhanceDocs: document.getElementById('enhance-docs')
        };

        // Initialize the application
        function init() {
            // Set initial theme
            setTheme(appState.theme);
            
            // Load saved settings
            loadSettings();
            
            // Set up event listeners
            setupEventListeners();
            
            // Update UI based on initial state
            updateUI();
        }

        // Set up all event listeners
        function setupEventListeners() {
            // Theme toggle
            elements.themeToggle.addEventListener('click', toggleTheme);
            
            // File handling
            elements.uploadBtn.addEventListener('click', () => elements.fileInput.click());
            elements.selectFilesBtn.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', handleFileSelect);
            elements.uploadZone.addEventListener('dragover', handleDragOver);
            elements.uploadZone.addEventListener('dragleave', handleDragLeave);
            elements.uploadZone.addEventListener('drop', handleFileDrop);
            
            // Editor controls
            elements.detectBtn.addEventListener('click', detectDocuments);
            elements.addCropBtn.addEventListener('click', startManualCrop);
            elements.resetCropsBtn.addEventListener('click', resetCrops);
            elements.downloadBtn.addEventListener('click', downloadAllCrops);
            
            // Canvas events for crop creation and manipulation
            elements.editorCanvas.addEventListener('mousedown', startDrawing);
            elements.editorCanvas.addEventListener('mousemove', draw);
            elements.editorCanvas.addEventListener('mouseup', stopDrawing);
            elements.editorCanvas.addEventListener('touchstart', handleTouchStart);
            elements.editorCanvas.addEventListener('touchmove', handleTouchMove);
            elements.editorCanvas.addEventListener('touchend', handleTouchEnd);
            
            // Settings modal
            elements.settingsBtn.addEventListener('click', openSettings);
            elements.settingsClose.addEventListener('click', closeSettings);
            elements.settingsCancel.addEventListener('click', closeSettings);
            elements.settingsSave.addEventListener('click', saveSettings);
            
            // Settings form updates
            elements.outputFormat.addEventListener('change', updateJpgQualityVisibility);
            elements.jpgQuality.addEventListener('input', updateJpgQualityValue);
            
            // AI Detection settings
            elements.detectionSensitivity.addEventListener('input', updateSensitivityValue);
            elements.edgeThreshold.addEventListener('input', updateEdgeValue);
            elements.minDocSize.addEventListener('input', updateSizeValue);
        }

        // AI-Powered Document Detection
        async function detectDocuments() {
            if (appState.currentFileIndex < 0) return;
            
            const file = appState.files[appState.currentFileIndex];
            file.status = 'processing';
            updateFileItem(file);
            
            try {
                // Load image for detection
                const img = new Image();
                const imageUrl = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file.file);
                });
                
                img.onload = async () => {
                    // Use AI detector to find documents
                    const documents = await appState.detector.detectDocuments(
                        img,
                        appState.settings.detectionSensitivity,
                        appState.settings.edgeThreshold,
                        appState.settings.minDocSize
                    );
                    
                    // Convert detections to crop regions
                    file.crops = documents.map((doc, index) => ({
                        id: generateId(),
                        name: `Document ${index + 1}`,
                        x: doc.x,
                        y: doc.y,
                        width: doc.width,
                        height: doc.height,
                        rotation: doc.rotation,
                        confidence: doc.confidence
                    }));
                    
                    file.status = 'done';
                    
                    // Update current crops if this is the active file
                    if (appState.files[appState.currentFileIndex]?.id === file.id) {
                        appState.crops = [...file.crops];
                        updateCropsList();
                        drawCropRegions();
                    }
                    
                    updateFileItem(file);
                    updateUI();
                };
                
                img.src = imageUrl;
                
            } catch (error) {
                console.error('Document detection failed:', error);
                file.status = 'error';
                updateFileItem(file);
            }
        }

        // Enhanced crop processing with AI features
        function processCrop(crop, originalImage, index) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size to crop dimensions
                canvas.width = crop.width;
                canvas.height = crop.height;
                
                // Apply deskew if enabled
                if (appState.settings.deskewDocs && crop.rotation !== 0) {
                    ctx = ImageProcessor.deskewImage(ctx, 0, 0, crop.width, crop.height, crop.rotation);
                }
                
                // Draw the cropped region
                ctx.drawImage(
                    originalImage,
                    crop.x, crop.y, crop.width, crop.height,
                    0, 0, crop.width, crop.height
                );
                
                // Apply enhancements if enabled
                if (appState.settings.enhanceDocs) {
                    ctx = ImageProcessor.enhanceDocument(
                        ctx, 
                        crop.width, 
                        crop.height, 
                        appState.settings.processingMode
                    );
                }
                
                // Remove background if enabled
                if (appState.settings.shadowCleanup) {
                    ctx = ImageProcessor.removeBackground(ctx, crop.width, crop.height);
                }
                
                // Convert to desired format
                const dataUrl = canvas.toDataURL(
                    `image/${appState.settings.outputFormat}`,
                    appState.settings.outputFormat === 'jpg' ? appState.settings.jpgQuality / 100 : 1
                );
                
                resolve({
                    dataUrl: dataUrl,
                    filename: generateFilename(appState.files[appState.currentFileIndex], crop, index)
                });
            });
        }

        // Enhanced download function with AI processing
        async function downloadAllCrops() {
            const zip = new JSZip();
            let processedCount = 0;
            const totalCrops = appState.files.reduce((sum, file) => sum + file.crops.length, 0);
            
            // Show progress
            elements.downloadBtn.disabled = true;
            elements.downloadBtn.innerHTML = `Processing... (0/${totalCrops})`;
            
            for (const file of appState.files) {
                if (file.crops.length > 0) {
                    // Load the original image once per file
                    const img = new Image();
                    const imageUrl = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file.file);
                    });
                    
                    await new Promise((resolve) => {
                        img.onload = async () => {
                            // Process each crop in the file
                            for (let i = 0; i < file.crops.length; i++) {
                                const crop = file.crops[i];
                                const result = await processCrop(crop, img, i);
                                
                                // Extract base64 data and add to ZIP
                                const base64Data = result.dataUrl.split(',')[1];
                                zip.file(result.filename, base64Data, { base64: true });
                                
                                processedCount++;
                                elements.downloadBtn.innerHTML = `Processing... (${processedCount}/${totalCrops})`;
                            }
                            resolve();
                        };
                        img.src = imageUrl;
                    });
                }
            }
            
            // Generate and download ZIP
            zip.generateAsync({ type: 'blob' }).then(function(content) {
                saveAs(content, `BatchDocCropper_${new Date().toISOString().slice(0, 10)}.zip`);
                
                // Reset button
                elements.downloadBtn.disabled = false;
                elements.downloadBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download Cropped Images (ZIP)
                `;
            });
        }

        // AI Detection settings handlers
        function updateSensitivityValue() {
            elements.sensitivityValue.textContent = elements.detectionSensitivity.value;
        }

        function updateEdgeValue() {
            elements.edgeValue.textContent = elements.edgeThreshold.value;
        }

        function updateSizeValue() {
            elements.sizeValue.textContent = elements.minDocSize.value + '%';
        }

        // [Rest of the functions remain the same as in the previous implementation...]
        // Theme handling, file handling, UI updates, etc.

        // Initialize the app when the DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
